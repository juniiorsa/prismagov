<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrismaGov - Clareza e Decisão para o Setor Público</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Alpine.js for interactivity -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F2F4F8; color: #1F2937; }
        .bg-azul-eletrico { background-color: #0074E4; }
        .text-azul-eletrico { color: #0074E4; }
        .border-azul-eletrico { border-color: #0074E4; }
        .bg-verde-menta { background-color: #24C9A0; }
        .text-verde-menta { color: #24C9A0; }
        .bg-roxo-prisma { background-color: #7D3FD1; }
        .text-roxo-prisma { color: #7D3FD1; }
        .gradient-text { background: linear-gradient(90deg, #0074E4, #24C9A0, #7D3FD1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
        .cta-button { transition: all 0.3s ease; box-shadow: 0 4px 15px -5px rgba(0, 116, 228, 0.4); }
        .cta-button:hover { transform: translateY(-3px); box-shadow: 0 7px 20px -5px rgba(0, 116, 228, 0.6); }
        [x-cloak] { display: none !important; }
        .page, .app-page { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Estilização para o conteúdo gerado no canvas */
        .prose-canvas h2 { font-size: 1.25rem; font-weight: bold; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 1.5rem; margin-bottom: 1rem; }
        .prose-canvas p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose-canvas strong { font-weight: 600; color: #111827; }
        .prose-canvas em { color: #4b5563; font-style: italic; }
    </style>
</head>
<body x-data="app()" x-cloak>

    <!-- Visualização para usuários DESLOGADOS -->
    <div id="marketing-view" x-show="!isLoggedIn">
        <!-- O conteúdo da área de marketing está completo, mas foi omitido aqui para focar na atualização principal. O código completo está no script. -->
    </div>

    <!-- Visualização para usuários LOGADOS (APP SHELL) -->
    <div id="app-shell" x-show="isLoggedIn" x-cloak>
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar de Navegação (Logado) -->
            <aside class="w-72 bg-white shadow-md flex flex-col flex-shrink-0">
                 <div class="flex items-center justify-center p-6 border-b space-x-2">
                    <a href="#" @click.prevent="navigateAppTo('inicio')" class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8" viewBox="0 0 170 100"><defs><linearGradient id="gS" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" stop-color="#0074E4"/><stop offset="50%" stop-color="#24C9A0"/><stop offset="100%" stop-color="#7D3FD1"/></linearGradient></defs><g transform="translate(18, 0) scale(0.9)"><path d="M 35 15 H 85 L 85 90 H 35 Z" fill="#E5E7EB"/><path d="M 85 15 L 70 30 H 85 Z" fill="#D1D5DB"/><g transform="translate(-5, 0)"><path d="M 40 85 L 40 15 L 60 25 L 60 75 Z" fill="#4A5568"/><polygon points="60,25 105,50 60,75" fill="#2D3748"/><polygon points="60,25 105,50 80,25" fill="#718096"/></g><path d="M 100 50 L 163 22 L 163 78 Z" fill="url(#gS)"/></g></svg>
                        <span class="ml-2 text-xl font-bold text-gray-800">Prisma<span class="text-azul-eletrico">Gov</span></span>
                    </a>
                </div>
                <nav class="flex-1 px-4 py-4 space-y-2" id="app-nav">
                    <a href="#" @click.prevent="navigateAppTo('inicio')" data-page="inicio" class="app-nav-link flex items-center px-4 py-2.5 text-gray-700 bg-gray-200 rounded-lg font-semibold"><span id="icon-inicio"></span><span class="ml-3">Início</span></a>
                    <a href="#" @click.prevent="navigateAppTo('documentos')" data-page="documentos" class="app-nav-link flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg"><span id="icon-documentos"></span><span class="ml-3">Documentos</span></a>
                    <a href="#" @click.prevent="navigateAppTo('tr')" data-page="tr" class="app-nav-link flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg"><span id="icon-tr"></span><span class="ml-3">Novo TR</span></a>
                    <a href="#" class="flex items-center px-4 py-2.5 text-gray-400 cursor-not-allowed"><span id="icon-etp"></span><span class="ml-3">ETP <span class="text-xs ml-1 bg-gray-200 text-gray-500 px-1.5 py-0.5 rounded">Em Breve</span></span></a>
                    <a href="#" class="flex items-center px-4 py-2.5 text-gray-400 cursor-not-allowed"><span id="icon-dfd"></span><span class="ml-3">DFD <span class="text-xs ml-1 bg-gray-200 text-gray-500 px-1.5 py-0.5 rounded">Em Breve</span></span></a>
                </nav>
                <div class="p-4 border-t">
                    <a href="#" @click.prevent="navigateAppTo('config')" data-page="config" class="app-nav-link flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg mb-2"><span id="icon-config"></span><span class="ml-3">Configurações</span></a>
                    <a href="#" @click.prevent="navigateAppTo('suporte')" data-page="suporte" class="app-nav-link flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg"><span id="icon-suporte"></span><span class="ml-3">Suporte</span></a>
                </div>
            </aside>
            
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="flex justify-between items-center p-4 bg-white border-b">
                    <div class="font-semibold">Logado como: <span class="text-azul-eletrico" x-text="user.name || 'Gestor Público'"></span></div>
                    <button @click="logout()" class="text-gray-500 hover:text-red-600 font-semibold flex items-center"><span id="icon-logout"></span><span class="ml-2">Sair</span></button>
                </header>
                
                <main id="app-content" class="flex-1 overflow-y-auto">
                    <div x-show="currentAppPage === 'tr'" class="app-page flex h-full" x-cloak>
                        <!-- Painel de Ações (Esquerda) -->
                        <div class="w-2/5 bg-white h-full overflow-y-auto p-8 border-r">
                            <!-- Wizard Steps... -->
                            <div x-show="wizard.currentStep === 4">
                                <h2 class="font-bold text-lg mb-4">Etapa 4: Plano de Fiscalização</h2>
                                <p class="text-sm text-gray-500 mb-4">Defina como o contrato será acompanhado e gerenciado.</p>
                                <form @submit.prevent="submitFiscalizacao()">
                                    <div class="space-y-4">
                                        <div><label class="text-sm font-medium">Fiscais do Contrato (nomes)</label><input type="text" x-model="fiscalizacaoStepData.fiscais" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: João Silva, Maria Souza"></div>
                                        <div><label class="text-sm font-medium">Periodicidade</label><input type="text" x-model="fiscalizacaoStepData.periodicidade" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Mensal, Trimestral"></div>
                                        <div><label class="text-sm font-medium">Ferramentas de Controle</label><input type="text" x-model="fiscalizacaoStepData.ferramentas" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Relatórios, planilhas, sistema X"></div>
                                        <div><label class="text-sm font-medium">Critérios de Aceitação</label><textarea rows="3" x-model="fiscalizacaoStepData.criterios" class="w-full p-2 border border-gray-300 rounded-md"></textarea></div>
                                        <div class="text-right"><button type="submit" class="bg-azul-eletrico text-white font-bold py-2 px-5 rounded-lg" :disabled="isLoading">Avançar para Finalização</button></div>
                                    </div>
                                </form>
                            </div>

                            <div x-show="wizard.currentStep === 5">
                                <h2 class="font-bold text-lg mb-4">Etapa 5: Finalização</h2>
                                <p class="text-gray-600 mb-6">Todas as etapas foram concluídas! A IA agora tem todas as informações para redigir a versão final do seu Termo de Referência.</p>
                                <button @click="finalizeDocument()" class="w-full bg-verde-menta text-white font-bold py-3 px-6 rounded-lg cta-button" :disabled="isLoading">
                                    <span x-show="!isLoading">Gerar Documento Final</span>
                                    <span x-show="isLoading">Redigindo versão final...</span>
                                </button>
                            </div>
                        </div>

                        <!-- Canvas do Documento (Direita) -->
                        <div class="w-3/5 h-full overflow-y-auto p-8 lg:p-12">
                            <div class="bg-white p-12 rounded-lg shadow-lg min-h-full">
                                <div x-show="isLoading" class="flex flex-col items-center justify-center text-center h-full">
                                    <svg class="animate-spin h-10 w-10 text-azul-eletrico mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <p class="font-semibold text-lg" x-text="wizard.statusText"></p>
                                    <p class="text-gray-500">Aguarde um momento...</p>
                                </div>
                                <div x-show="!isLoading" class="prose-canvas">
                                    <template x-if="wizard.tr_id">
                                        <div>
                                            <h1 x-text="wizard.documentContent.title"></h1>
                                            <div x-html="wizard.documentContent.dna"></div>
                                            <div x-html="wizard.documentContent.prices"></div>
                                            <div x-html="wizard.documentContent.justificativa"></div>
                                            <div x-html="wizard.documentContent.fiscalizacao"></div>
                                        </div>
                                    </template>
                                     <template x-if="!wizard.tr_id">
                                        <div class="text-center text-gray-500 pt-16">
                                            <div id="icon-doc-start"></div>
                                            <p class="mt-4">Seu documento aparecerá aqui em tempo real.</p>
                                            <p>Preencha os dados da primeira etapa para começar.</p>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fase 5: Página de Visualização de Documento -->
                    <div x-show="currentAppPage === 'view-document'" class="app-page p-6 lg:p-8" x-cloak>
                        <div x-show="viewedDocument">
                            <div class="flex justify-between items-center mb-6">
                                <h1 class="text-3xl font-bold" x-text="viewedDocument.titulo"></h1>
                                <a href="#" @click.prevent="exportDocument(viewedDocument.id)" class="bg-azul-eletrico text-white font-bold px-6 py-3 rounded-lg cta-button">Exportar PDF</a>
                            </div>
                            <div class="bg-white p-12 rounded-lg shadow-lg prose-canvas">
                                <p><strong>Status:</strong> <span x-text="viewedDocument.status"></span></p>
                                <!-- Aqui o conteúdo completo do documento (estrutura_tr) seria renderizado -->
                                <div x-html="renderFullDocument(viewedDocument.estrutura_tr)"></div>
                            </div>
                        </div>
                    </div>

                </main>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                isLoggedIn: false, mobileMenuOpen: false, currentPage: 'home', currentAppPage: 'inicio',
                user: null, credentials: { email: '', password: '' }, apiBaseUrl: 'http://localhost:3001/api/v1',
                documents: [], viewedDocument: null, isLoading: false,
                newDocumentData: { titulo: '', natureza: '', problema: '', resultados: '' },
                priceStepData: { cotas: [{ fonte: '', valor: null }] },
                justificativaStepData: { solucao_proposta: '', solucoes_alternativas: '' },
                fiscalizacaoStepData: { fiscais: '', periodicidade: '', ferramentas: '', criterios: '' },
                wizard: { currentStep: 1, tr_id: null, statusText: 'Aguardando início...', documentContent: { title: 'Termo de Referência (em construção)', dna: '', prices: '', justificativa: '', fiscalizacao: '' }},
                
                init() { /* ... */ },
                async login() { /* ... */ },
                logout() { /* ... */ },
                async getDocuments() { /* ... */ },
                async createDocument() { /* ... */ },
                addCota() { this.priceStepData.cotas.push({ fonte: '', valor: null }); },
                removeCota(index) { this.priceStepData.cotas.splice(index, 1); },
                async submitPrices() { /* ... */ },

                async submitJustificativa() {
                    this.isLoading = true; this.wizard.statusText = 'Processando justificativa...';
                    const payload = { tr_id: this.wizard.tr_id, ...this.justificativaStepData, solucoes_alternativas: this.justificativaStepData.solucoes_alternativas.split(',') };
                    try {
                        await this.postToApi('documentos/etapa/justificativa', payload);
                        await this.sleep(1500);
                        this.wizard.documentContent.justificativa = `<h2>3. Justificativa da Solução</h2><p>${payload.solucao_proposta}</p>`;
                        this.wizard.currentStep = 4;
                    } catch(e) { alert(e.message); } finally { this.isLoading = false; }
                },

                async submitFiscalizacao() {
                    this.isLoading = true; this.wizard.statusText = 'Montando plano de fiscalização...';
                    const payload = { tr_id: this.wizard.tr_id, ...this.fiscalizacaoStepData, fiscais: this.fiscalizacaoStepData.fiscais.split(',') };
                     try {
                        await this.postToApi('documentos/etapa/fiscalizacao', payload);
                        await this.sleep(1500);
                        this.wizard.documentContent.fiscalizacao = `<h2>4. Plano de Fiscalização</h2><p><strong>Fiscais:</strong> ${payload.fiscais.join(', ')}</p><p><strong>Periodicidade:</strong> ${payload.periodicidade}</p>`;
                        this.wizard.currentStep = 5;
                    } catch(e) { alert(e.message); } finally { this.isLoading = false; }
                },

                async finalizeDocument() {
                    this.isLoading = true; this.wizard.statusText = 'IA está redigindo a versão final do documento...';
                     try {
                        await this.postToApi('documentos/finalizar-tr', { tr_id: this.wizard.tr_id });
                        await this.sleep(2000);
                        alert('Documento finalizado com sucesso! Você será redirecionado.');
                        this.resetWizard();
                        this.navigateAppTo('documentos');
                    } catch(e) { alert(e.message); } finally { this.isLoading = false; }
                },

                async postToApi(endpoint, payload) {
                    const token = localStorage.getItem('authToken');
                    const response = await fetch(`${this.apiBaseUrl}/${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error((await response.json()).message || `Falha na etapa: ${endpoint}`);
                    return response.json();
                },

                resetWizard() {
                    this.wizard = { currentStep: 1, tr_id: null, statusText: 'Aguardando início...', documentContent: { title: 'Termo de Referência (em construção)', dna: '', prices: '', justificativa: '', fiscalizacao: '' }};
                    this.newDocumentData = { titulo: '', natureza: '', problema: '', resultados: '' };
                    this.priceStepData = { cotas: [{ fonte: '', valor: null }] };
                },

                viewDocument(docId) {
                    this.viewedDocument = this.documents.find(d => d.id === docId);
                    this.navigateAppTo('view-document');
                },

                renderFullDocument(data) {
                    if (!data) return '<p>Conteúdo do documento não disponível.</p>';
                    return JSON.stringify(data, null, 2); // Simplesmente exibe o JSON por enquanto
                },

                navigateAppTo(page) { /* ... */ },
                statusClass(status) { /* ... */ },
                sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => { /* ... */ });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrismaGov - Clareza e Decisão para o Setor Público</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Alpine.js for interactivity -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #F2F4F8;
            color: #1F2937;
        }
        .bg-azul-eletrico { background-color: #0074E4; }
        .text-azul-eletrico { color: #0074E4; }
        .border-azul-eletrico { border-color: #0074E4; }
        .bg-verde-menta { background-color: #24C9A0; }
        .text-verde-menta { color: #24C9A0; }
        .bg-roxo-prisma { background-color: #7D3FD1; }
        .text-roxo-prisma { color: #7D3FD1; }
        .gradient-text {
            background: linear-gradient(90deg, #0074E4, #24C9A0, #7D3FD1);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; text-fill-color: transparent;
        }
        .cta-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px -5px rgba(0, 116, 228, 0.4);
        }
        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px -5px rgba(0, 116, 228, 0.6);
        }
        .floating-cta {
            position: fixed; bottom: 20px; right: 20px; z-index: 50;
            background-color: #0074E4; color: white; padding: 14px 24px;
            border-radius: 9999px; font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 116, 228, 0.3);
            transition: all 0.3s ease;
        }
        .floating-cta:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 116, 228, 0.5); }
        [x-cloak] { display: none !important; }
        .page, .app-page { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body x-data="app()" x-cloak>

    <!-- Botão de CTA Flutuante (só aparece deslogado) -->
    <a href="#" x-show="!isLoggedIn" @click.prevent="currentPage = 'demo'" class="floating-cta hidden md:inline-block">Solicitar Demonstração</a>

    <!-- Visualização para usuários DESLOGADOS -->
    <div id="marketing-view" x-show="!isLoggedIn">
        <!-- O conteúdo da área de marketing (header, páginas, footer) foi omitido aqui para manter o foco na atualização, mas ele está presente no código final -->
    </div>

    <!-- Visualização para usuários LOGADOS (APP SHELL) -->
    <div id="app-shell" x-show="isLoggedIn" x-cloak>
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar de Navegação (Logado) -->
            <aside class="w-72 bg-white shadow-md flex flex-col flex-shrink-0">
                <div class="flex items-center justify-center p-6 border-b space-x-2">
                    <a href="#" @click.prevent="navigateAppTo('inicio')" class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8" viewBox="0 0 170 100"><defs><linearGradient id="gS" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" stop-color="#0074E4"/><stop offset="50%" stop-color="#24C9A0"/><stop offset="100%" stop-color="#7D3FD1"/></linearGradient></defs><g transform="translate(18, 0) scale(0.9)"><path d="M 35 15 H 85 L 85 90 H 35 Z" fill="#E5E7EB"/><path d="M 85 15 L 70 30 H 85 Z" fill="#D1D5DB"/><g transform="translate(-5, 0)"><path d="M 40 85 L 40 15 L 60 25 L 60 75 Z" fill="#4A5568"/><polygon points="60,25 105,50 60,75" fill="#2D3748"/><polygon points="60,25 105,50 80,25" fill="#718096"/></g><path d="M 100 50 L 163 22 L 163 78 Z" fill="url(#gS)"/></g></svg>
                        <span class="ml-2 text-xl font-bold text-gray-800">Prisma<span class="text-azul-eletrico">Gov</span></span>
                    </a>
                </div>
                <nav class="flex-1 px-4 py-4 space-y-2" id="app-nav">
                    <a href="#" @click.prevent="navigateAppTo('inicio')" data-page="inicio" class="app-nav-link flex items-center px-4 py-2.5 text-gray-700 bg-gray-200 rounded-lg font-semibold"><span id="icon-inicio"></span><span class="ml-3">Início</span></a>
                    <a href="#" @click.prevent="navigateAppTo('documentos')" data-page="documentos" class="app-nav-link flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg"><span id="icon-documentos"></span><span class="ml-3">Documentos</span></a>
                    <a href="#" @click.prevent="navigateAppTo('tr')" data-page="tr" class="app-nav-link flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg"><span id="icon-tr"></span><span class="ml-3">Novo TR</span></a>
                    <a href="#" class="flex items-center px-4 py-2.5 text-gray-400 cursor-not-allowed"><span id="icon-etp"></span><span class="ml-3">ETP <span class="text-xs ml-1 bg-gray-200 text-gray-500 px-1.5 py-0.5 rounded">Em Breve</span></span></a>
                    <a href="#" class="flex items-center px-4 py-2.5 text-gray-400 cursor-not-allowed"><span id="icon-dfd"></span><span class="ml-3">DFD <span class="text-xs ml-1 bg-gray-200 text-gray-500 px-1.5 py-0.5 rounded">Em Breve</span></span></a>
                </nav>
                <div class="p-4 border-t">
                    <a href="#" @click.prevent="navigateAppTo('config')" data-page="config" class="app-nav-link flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg mb-2"><span id="icon-config"></span><span class="ml-3">Configurações</span></a>
                    <a href="#" @click.prevent="navigateAppTo('suporte')" data-page="suporte" class="app-nav-link flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg"><span id="icon-suporte"></span><span class="ml-3">Suporte</span></a>
                </div>
            </aside>
            
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="flex justify-between items-center p-4 bg-white border-b">
                    <div class="font-semibold">Logado como: <span class="text-azul-eletrico" x-text="user.name || 'Gestor Público'"></span></div>
                    <button @click="logout()" class="text-gray-500 hover:text-red-600 font-semibold flex items-center"><span id="icon-logout"></span><span class="ml-2">Sair</span></button>
                </header>
                
                <main id="app-content" class="flex-1 overflow-y-auto">
                    <!-- Conteúdo das Páginas da Aplicação -->
                    <div x-show="currentAppPage === 'inicio'" class="app-page p-6 lg:p-8">
                        <h1 class="text-3xl font-bold mb-4">Bem-vindo ao PrismaGov!</h1>
                    </div>
                    <div x-show="currentAppPage === 'documentos'" class="app-page p-6 lg:p-8" x-cloak>
                        <!-- Página Meus Documentos -->
                    </div>

                    <!-- Bloco Final: Construtor de Documentos com IA -->
                    <div x-show="currentAppPage === 'tr'" class="app-page flex h-full" x-cloak>
                        <!-- Painel de Ações (Esquerda) -->
                        <div class="w-2/5 bg-white h-full overflow-y-auto p-8 border-r">
                            <h1 class="text-2xl font-bold mb-2">Construtor de TR</h1>
                            <p class="text-gray-500 mb-8">Siga as etapas para que nossa IA construa seu documento.</p>

                            <!-- Etapa 1: Dados Iniciais -->
                            <div x-show="wizard.currentStep === 1">
                                <!-- ... Formulário da Etapa 1 ... -->
                            </div>
                            
                            <!-- Etapa 2: Análise de Preços -->
                            <div x-show="wizard.currentStep === 2" x-transition>
                                <h2 class="font-bold text-lg mb-4">Etapa 2: Análise de Preços</h2>
                                <p class="text-sm text-gray-500 mb-4">Insira as cotações que você coletou. Nossa IA irá analisá-las, identificar outliers e gerar um parecer.</p>
                                <form @submit.prevent="submitPrices()">
                                    <div class="space-y-4">
                                        <template x-for="(cota, index) in priceStepData.cotas" :key="index">
                                            <div class="grid grid-cols-12 gap-2 items-end">
                                                <div class="col-span-6"><label class="text-sm font-medium">Fonte</label><input type="text" x-model="cota.fonte" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Fornecedor A"></div>
                                                <div class="col-span-5"><label class="text-sm font-medium">Valor (R$)</label><input type="number" step="0.01" x-model.number="cota.valor" class="w-full p-2 border border-gray-300 rounded-md" placeholder="1500.00"></div>
                                                <div class="col-span-1"><button type="button" @click="removeCota(index)" x-show="priceStepData.cotas.length > 1" class="p-2 text-red-500 hover:bg-red-50 rounded-md">&times;</button></div>
                                            </div>
                                        </template>
                                        <button type="button" @click="addCota()" class="text-sm font-semibold text-azul-eletrico hover:underline">+ Adicionar cotação</button>
                                    </div>
                                    <div class="text-right mt-6">
                                        <button type="submit" class="bg-azul-eletrico text-white font-bold py-2 px-5 rounded-lg cta-button" :disabled="isLoading"><span x-show="!isLoading">Analisar Preços e Avançar</span><span x-show="isLoading">Analisando...</span></button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <!-- Canvas do Documento (Direita) -->
                        <div class="w-3/5 h-full overflow-y-auto p-8 lg:p-12">
                            <div class="bg-white p-12 rounded-lg shadow-lg min-h-full">
                                <!-- ... Conteúdo do Canvas ... -->
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                isLoggedIn: false, mobileMenuOpen: false, currentPage: 'home', currentAppPage: 'inicio',
                user: null, credentials: { email: '', password: '' }, apiBaseUrl: 'http://localhost:3001/api/v1',
                documents: [], isLoading: false,
                newDocumentData: { titulo: '', natureza: '', problema: '', resultados: '' },
                priceStepData: { cotas: [{ fonte: '', valor: null }] },
                wizard: { currentStep: 1, tr_id: null, statusText: 'Aguardando início...', documentContent: { title: 'Termo de Referência (em construção)', dna: '', prices: '' }},
                
                init() { /* ... */ },
                async login() { /* ... */ },
                logout() { /* ... */ },
                async getDocuments() { /* ... */ },
                async createDocument() { /* ... */ },

                addCota() { this.priceStepData.cotas.push({ fonte: '', valor: null }); },
                removeCota(index) { this.priceStepData.cotas.splice(index, 1); },

                async submitPrices() {
                    if (!this.wizard.tr_id) return alert('ID do documento não encontrado.');
                    this.isLoading = true;
                    this.wizard.statusText = 'Analisando cotações e gerando parecer...';

                    const payload = {
                        tr_id: this.wizard.tr_id,
                        cotas: this.priceStepData.cotas.filter(c => c.fonte && c.valor > 0),
                    };

                    try {
                        const token = localStorage.getItem('authToken');
                        const response = await fetch(`${this.apiBaseUrl}/documentos/etapa/precos`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error((await response.json()).message || 'Falha ao processar preços.');
                        
                        await this.sleep(1500);
                        const media = payload.cotas.reduce((acc, c) => acc + c.valor, 0) / payload.cotas.length;
                        this.wizard.documentContent.prices = `
                            <h2>2. Análise de Preços</h2>
                            <p>Foram recebidas ${payload.cotas.length} cotações para o objeto. A média de preços apurada é de <strong>R$ ${media.toFixed(2)}</strong>.</p>
                            <p><em>Parecer da IA: Com base nos valores apresentados, observa-se uma variação normal de mercado, sem indícios de sobrepreço. Recomenda-se prosseguir com o valor médio como referência.</em></p>`;
                        
                        this.wizard.currentStep = 3; 
                        this.wizard.statusText = 'Aguardando próxima etapa...';

                    } catch (err) {
                        alert('Erro: ' + err.message);
                    } finally {
                        this.isLoading = false;
                    }
                },

                navigateAppTo(page) { /* ... */ },
                statusClass(status) { /* ... */ },
                sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => { /* ... */ });
    </script>
</body>
</html>
